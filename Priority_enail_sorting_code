import imaplib
import email
from email.utils import parseaddr
import time

IMAP_SERVER = "imap.gmail.com"
EMAIL_ACCOUNT = "chinmayji85@gmail.com"
PASSWORD = "dvkf nqgt ayld mxxm"

IMPORTANT_SENDERS = [
    "pramathrai@gmail.com",
    "pramathrai69@gmail.com",
    "bhairavjikima@gmail.com",
    "dhruvajiki@gmail.com",
    "mosterjaljeera@gmail.com"
    "poojarydhanush74@gmail.com"
]

TARGET_LABEL = "palpal"

mail = imaplib.IMAP4_SSL(IMAP_SERVER)

print("Trying to login...")
try:
    mail.login(EMAIL_ACCOUNT, PASSWORD)
    print("Login successful!")
except Exception as e:
    print("Login FAILED:", e)
    exit()

try:
    mail.create(f'"{TARGET_LABEL}"')
except:
    pass

mail.select("inbox")

result, data = mail.uid('search', None, "ALL")
mail_uids = data[0].split()

for uid in mail_uids:

    msg_data = None
    for attempt in range(3):
        result2, msg_data = mail.uid('fetch', uid, "(RFC822)")
        if msg_data and msg_data[0]:
            break
        print(f"Fetch failed for UID {uid}, retrying...")
        time.sleep(0.5)
    else:
        print(f"Skipping UID {uid} - fetch failed after 3 attempts.")
        continue

    msg = email.message_from_bytes(msg_data[0][1])
    sender = msg["From"]
    real_email = parseaddr(sender)[1].lower()

    if real_email in (imp.lower() for imp in IMPORTANT_SENDERS):
        print(f"Important email from {real_email}. Labeling '{TARGET_LABEL}'...")

        copy_result = mail.uid('copy', uid, TARGET_LABEL)

        if copy_result[0] == 'OK':
            mail.uid('store', uid, '+FLAGS', '\\Seen')
        else:
            print(f"Failed to label email from {real_email}.")

mail.logout()
print("Important emails successfully labeled without skipping!")
